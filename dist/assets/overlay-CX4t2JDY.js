import{j as h,r as l,c as at}from"./index-D6HAasR3.js";const ht=({variant:t="primary",className:n="",loading:o=!1,disabled:a,children:i,...x})=>{const e=["visor-button",t==="ghost"?"visor-button--ghost":"visor-button--primary",o?"visor-button--loading":"",n].filter(Boolean).join(" ");return h.jsx("button",{className:e,disabled:a||o,...x,children:o?h.jsxs(h.Fragment,{children:[h.jsx("span",{className:"visor-button-spinner"}),h.jsx("span",{style:{opacity:.7},children:"Loading..."})]}):i})};function rt(t){const n=Math.max(t.width,t.height)*1.4,o=t.x+t.width/2-n/2,a=t.y+t.height/2-n/2;return{left:`${o}px`,top:`${a}px`,width:`${n}px`,height:`${n}px`,borderRadius:`${n}px`}}const dt={width:1920,height:1080};function ct(){return typeof window>"u"?dt:{width:window.innerWidth,height:window.innerHeight}}function R(t,n){return Math.min(Math.max(t,0),n)}function q(t){return{x:t.x+t.width/2,y:t.y+t.height/2}}function lt(t,n=t){const o=ct(),a=q(n),i=q(t),x=Math.max(Math.abs(i.y-a.y),120),e={x:R((a.x+i.x)/2,o.width),y:R(Math.min(a.y,i.y)-x,o.height)},X=R(a.x,o.width),y=R(a.y,o.height),m=R(i.x,o.width),b=R(i.y,o.height);return`M ${X} ${y} Q ${e.x} ${e.y} ${m} ${b}`}function xt(t,n){const o={left:`${n.x}px`,top:`${n.y}px`,width:`${n.width}px`,height:`${n.height}px`};return t==="circle"?{type:t,boxStyle:rt(n)}:t==="arrow"?{type:t,boxStyle:o,arrowPath:lt(n)}:{type:"box",boxStyle:{...o,borderRadius:"12px"}}}const ut=({instruction:t,viewportWidth:n,viewportHeight:o})=>{const a=l.useMemo(()=>wt(t,n,o),[t,n,o]);if(!t||!a)return null;const i=xt(t.shape,a),x=ft(a,n,o);return h.jsxs("div",{className:"annotation-layer",children:[i.type==="box"&&h.jsx("div",{className:"annotation-box",style:i.boxStyle}),i.type==="circle"&&h.jsx("div",{className:"annotation-circle",style:i.boxStyle}),i.type==="arrow"&&i.arrowPath&&h.jsx("svg",{className:"annotation-arrow",viewBox:`0 0 ${n} ${o}`,preserveAspectRatio:"xMidYMid meet",children:h.jsx("path",{d:i.arrowPath})}),h.jsx("div",{className:"annotation-label",style:x,children:t.label})]})};function wt(t,n,o){if(!t)return null;const a=n||(typeof window<"u"?window.innerWidth:1920),i=o||(typeof window<"u"?window.innerHeight:1080),x=t.viewport?.width??a,e=t.viewport?.height??i,X=x?a/x:1,y=e?i/e:1,m=t.bboxPixels?{x:t.bboxPixels.x,y:t.bboxPixels.y,width:t.bboxPixels.width,height:t.bboxPixels.height}:t.bbox?{x:t.bbox.x*x,y:t.bbox.y*e,width:t.bbox.width*x,height:t.bbox.height*e}:null;return m?mt({x:m.x*X,y:m.y*y,width:m.width*X,height:m.height*y},a,i):null}function mt(t,n,o){const a=Math.min(t.width,n),i=Math.min(t.height,o);return{x:Math.min(Math.max(t.x,0),Math.max(0,n-a)),y:Math.min(Math.max(t.y,0),Math.max(0,o-i)),width:Math.max(1,a),height:Math.max(1,i)}}function ft(t,n,o){const i=Math.max(0,n-220),x=Math.min(Math.max(t.x,0),i),e=Math.min(t.y+t.height+12,Math.max(0,o-60));return{left:`${x}px`,top:`${e}px`}}const yt={width:typeof window<"u"?window.innerWidth:1920,height:typeof window<"u"?window.innerHeight:1080},Mt=()=>{const[t,n]=l.useState([]),[o,a]=l.useState(0),[i,x]=l.useState(!1),[e,X]=l.useState(yt),[y,m]=l.useState(()=>{const r=typeof window<"u"?window.innerWidth:1920,f=320,s=32;return{x:Math.max(0,r-f-s),y:s}}),[b,z]=l.useState(!1),$=l.useRef(null),H=l.useRef(null),[J,U]=l.useState(!1),S=l.useRef(null),u=typeof window<"u"?window.visor?.overlay:void 0,g=t[o]??null,_=l.useMemo(()=>t.slice(o),[t,o]);l.useEffect(()=>{if(typeof window>"u")return;const r=()=>{X({width:window.innerWidth,height:window.innerHeight}),m(f=>{const s=H.current,P=s?s.offsetWidth:320,E=s?s.offsetHeight:200,w=Math.max(0,window.innerWidth-P-8),Y=Math.max(0,window.innerHeight-E-8);return{x:Math.max(0,Math.min(f.x,w)),y:Math.max(0,Math.min(f.y,Y))}})};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]),l.useEffect(()=>{if(!u)return;u.ready?.();const r=u.onStepUpdate?.(s=>{x(!1),n(P=>{const E=P.findIndex(M=>M.id===s.id);let w,Y;E>=0?(w=[...P],w[E]=s,Y=E):(w=[...P,s],Y=w.length-1),a(Y);try{const M=s.viewport?.width??e.width,N=s.viewport?.height??e.height,k=M?e.width/M:1,Q=N?e.height/N:1,W=s.bboxPixels?{x:s.bboxPixels.x,y:s.bboxPixels.y,width:s.bboxPixels.width,height:s.bboxPixels.height}:s.bbox?{x:s.bbox.x*M,y:s.bbox.y*N,width:s.bbox.width*M,height:s.bbox.height*N}:null;if(W){const d={x:Math.max(0,Math.min(W.x*k,e.width)),y:Math.max(0,Math.min(W.y*Q,e.height)),width:Math.max(1,W.width*k),height:Math.max(1,W.height*Q)},B=12,tt=320,et=200,A=H.current,p=A?A.offsetWidth:tt,v=A?A.offsetHeight:et;let D=d.x+d.width+B,O=d.y;D+p+8>e.width&&(D=Math.max(8,d.x-p-B)),O+v+8>e.height&&(O=Math.max(8,e.height-v-8));const c=24,nt=Math.max(c,Math.min(Math.round(D),Math.max(c,e.width-p-c))),ot=Math.max(c,Math.min(Math.round(O),Math.max(c,e.height-v-c))),V=(I,T)=>{const j={x:I,y:T,width:p,height:v},it=Math.max(0,Math.min(j.x+j.width,d.x+d.width)-Math.max(j.x,d.x)),st=Math.max(0,Math.min(j.y+j.height,d.y+d.height)-Math.max(j.y,d.y));return it>0&&st>0};let L=nt,C=ot;if(V(L,C)){const I=Math.max(c,Math.min(Math.round(d.x-p-B),e.width-p-c));if(!V(I,d.y))L=I,C=Math.max(c,Math.min(d.y,e.height-v-c));else{const T=Math.max(c,Math.min(Math.round(d.y-v-B),e.height-v-c));if(!V(d.x,T))L=Math.max(c,Math.min(Math.round(d.x),e.width-p-c)),C=T;else{const j=Math.max(c,Math.min(Math.round(d.y+d.height+B),e.height-v-c));L=Math.max(c,Math.min(Math.round(d.x),e.width-p-c)),C=j}}}U(!0),S.current&&window.clearTimeout(S.current),S.current=window.setTimeout(()=>{U(!1),S.current=null},320),m({x:L,y:C})}}catch{}return w})}),f=u.onReset?.(()=>{n([]),a(0),x(!1)});return()=>{r?.(),f?.()}},[u]);const K=l.useCallback(()=>{g&&(x(!0),u?.markDone?.(g.id))},[g,u]),F=l.useCallback(r=>{u?.setPointerMode?.(r)},[u]),Z=l.useCallback(r=>{z(!0),$.current={mouseX:r.clientX,mouseY:r.clientY,x:y.x,y:y.y},u?.setPointerMode?.("interactive")},[y,u]);return l.useEffect(()=>{const r=s=>{if(!b||!$.current)return;const P=s.clientX-$.current.mouseX,E=s.clientY-$.current.mouseY,w=H.current,Y=w?w.offsetWidth:320,M=w?w.offsetHeight:200,N=Math.max(0,(typeof window<"u"?window.innerWidth:e.width)-Y-8),k=Math.max(0,(typeof window<"u"?window.innerHeight:e.height)-M-8);m({x:Math.max(0,Math.min(N,$.current.x+P)),y:Math.max(0,Math.min(k,$.current.y+E))})},f=()=>{z(!1),$.current=null,u?.setPointerMode?.("passthrough")};return b&&(window.addEventListener("mousemove",r),window.addEventListener("mouseup",f,{once:!0})),()=>{window.removeEventListener("mousemove",r),window.removeEventListener("mouseup",f)}},[b,u,e.height,e.width]),h.jsxs("div",{className:"overlay-shell",children:[h.jsx(ut,{instruction:g,viewportWidth:e.width,viewportHeight:e.height}),h.jsxs("section",{ref:r=>{H.current=r},className:`overlay-card ${b?"overlay-card-dragging":""} ${J?"overlay-moving":""}`,style:{position:"absolute",left:`${y.x}px`,top:`${y.y}px`,cursor:b?"grabbing":"grab"},onMouseEnter:()=>F("interactive"),onMouseLeave:()=>!b&&F("passthrough"),onMouseDown:Z,children:[h.jsx("p",{className:"overlay-label",children:g?"Next step":"Waiting for instructions"}),h.jsx("h1",{className:"overlay-title",children:g?.label??"No instruction yet"}),h.jsx("p",{className:"overlay-text",children:g?.step_description??"Trigger a task from the chat window to get started."}),_.length>0&&h.jsx("ol",{className:"overlay-step-list",children:_.map((r,f)=>h.jsxs("li",{className:f===0?"overlay-step-active":"",children:[h.jsx("strong",{children:r.label}),h.jsx("span",{children:r.step_description})]},r.id))}),h.jsx(ht,{onClick:K,disabled:!g,loading:i,children:"Mark done"})]})]})},G=document.getElementById("root");if(!G)throw new Error("Overlay root element not found");const bt=at.createRoot(G);bt.render(h.jsx(Mt,{}));
