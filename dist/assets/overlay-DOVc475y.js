import{j as r,r as d,c as X}from"./index-D6HAasR3.js";const Y=({variant:e="primary",className:t="",...n})=>{const i=["visor-button",e==="ghost"?"visor-button--ghost":"visor-button--primary",t].filter(Boolean).join(" ");return r.jsx("button",{className:i,...n})};function k(e){const t=Math.max(e.width,e.height)*1.4,n=e.x+e.width/2-t/2,i=e.y+e.height/2-t/2;return{left:`${n}px`,top:`${i}px`,width:`${t}px`,height:`${t}px`,borderRadius:`${t}px`}}const A={width:1920,height:1080};function C(){return typeof window>"u"?A:{width:window.innerWidth,height:window.innerHeight}}function v(e,t){return Math.min(Math.max(e,0),t)}function P(e){return{x:e.x+e.width/2,y:e.y+e.height/2}}function I(e,t=e){const n=C(),i=P(t),o=P(e),l=Math.max(Math.abs(o.y-i.y),120),a={x:v((i.x+o.x)/2,n.width),y:v(Math.min(i.y,o.y)-l,n.height)},p=v(i.x,n.width),u=v(i.y,n.height),f=v(o.x,n.width),m=v(o.y,n.height);return`M ${p} ${u} Q ${a.x} ${a.y} ${f} ${m}`}function H(e,t){const n={left:`${t.x}px`,top:`${t.y}px`,width:`${t.width}px`,height:`${t.height}px`};return e==="circle"?{type:e,boxStyle:k(t)}:e==="arrow"?{type:e,boxStyle:n,arrowPath:I(t)}:{type:"box",boxStyle:{...n,borderRadius:"12px"}}}const D=({instruction:e,viewportWidth:t,viewportHeight:n})=>{const i=d.useMemo(()=>V(e,t,n),[e,t,n]);if(!e||!i)return null;const o=H(e.shape,i),l=O(i,t,n);return r.jsxs("div",{className:"annotation-layer",children:[o.type==="box"&&r.jsx("div",{className:"annotation-box",style:o.boxStyle}),o.type==="circle"&&r.jsx("div",{className:"annotation-circle",style:o.boxStyle}),o.type==="arrow"&&o.arrowPath&&r.jsx("svg",{className:"annotation-arrow",viewBox:`0 0 ${t} ${n}`,preserveAspectRatio:"xMidYMid meet",children:r.jsx("path",{d:o.arrowPath})}),r.jsx("div",{className:"annotation-label",style:l,children:e.label})]})};function V(e,t,n){if(!e)return null;const i=t||(typeof window<"u"?window.innerWidth:1920),o=n||(typeof window<"u"?window.innerHeight:1080),l=e.viewport?.width??i,a=e.viewport?.height??o,p=l?i/l:1,u=a?o/a:1,f=e.bboxPixels?{x:e.bboxPixels.x,y:e.bboxPixels.y,width:e.bboxPixels.width,height:e.bboxPixels.height}:e.bbox?{x:e.bbox.x*l,y:e.bbox.y*a,width:e.bbox.width*l,height:e.bbox.height*a}:null;return f?z({x:f.x*p,y:f.y*u,width:f.width*p,height:f.height*u},i,o):null}function z(e,t,n){const i=Math.min(e.width,t),o=Math.min(e.height,n);return{x:Math.min(Math.max(e.x,0),Math.max(0,t-i)),y:Math.min(Math.max(e.y,0),Math.max(0,n-o)),width:Math.max(1,i),height:Math.max(1,o)}}function O(e,t,n){const o=Math.max(0,t-220),l=Math.min(Math.max(e.x,0),o),a=Math.min(e.y+e.height+12,Math.max(0,n-60));return{left:`${l}px`,top:`${a}px`}}const T={width:typeof window<"u"?window.innerWidth:1920,height:typeof window<"u"?window.innerHeight:1080},U=()=>{const[e,t]=d.useState([]),[n,i]=d.useState(0),[o,l]=d.useState(T),[a,p]=d.useState(()=>{const s=typeof window<"u"?window.innerWidth:1920,w=320,h=32;return{x:Math.max(0,s-w-h),y:h}}),[u,f]=d.useState(!1),m=d.useRef(null),j=d.useRef(null),c=typeof window<"u"?window.visor?.overlay:void 0,y=e[n]??null,S=d.useMemo(()=>e.slice(n),[e,n]);d.useEffect(()=>{if(typeof window>"u")return;const s=()=>{l({width:window.innerWidth,height:window.innerHeight}),p(w=>{const h=j.current,g=h?h.offsetWidth:320,b=h?h.offsetHeight:200,x=Math.max(0,window.innerWidth-g-8),M=Math.max(0,window.innerHeight-b-8);return{x:Math.max(0,Math.min(w.x,x)),y:Math.max(0,Math.min(w.y,M))}})};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),d.useEffect(()=>{if(!c)return;c.ready?.();const s=c.onStepUpdate?.(h=>{t(g=>{const b=g.findIndex($=>$.id===h.id);let x,M;return b>=0?(x=[...g],x[b]=h,M=b):(x=[...g,h],M=x.length-1),i(M),x})}),w=c.onReset?.(()=>{t([]),i(0)});return()=>{s?.(),w?.()}},[c]);const B=d.useCallback(()=>{y&&c?.markDone?.(y.id)},[y,c]),E=d.useCallback(s=>{c?.setPointerMode?.(s)},[c]),R=d.useCallback(s=>{f(!0),m.current={mouseX:s.clientX,mouseY:s.clientY,x:a.x,y:a.y},c?.setPointerMode?.("interactive")},[a,c]);return d.useEffect(()=>{const s=h=>{if(!u||!m.current)return;const g=h.clientX-m.current.mouseX,b=h.clientY-m.current.mouseY,x=j.current,M=x?x.offsetWidth:320,$=x?x.offsetHeight:200,L=Math.max(0,(typeof window<"u"?window.innerWidth:o.width)-M-8),W=Math.max(0,(typeof window<"u"?window.innerHeight:o.height)-$-8);p({x:Math.max(0,Math.min(L,m.current.x+g)),y:Math.max(0,Math.min(W,m.current.y+b))})},w=()=>{f(!1),m.current=null,c?.setPointerMode?.("passthrough")};return u&&(window.addEventListener("mousemove",s),window.addEventListener("mouseup",w,{once:!0})),()=>{window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",w)}},[u,c,o.height,o.width]),r.jsxs("div",{className:"overlay-shell",children:[r.jsx(D,{instruction:y,viewportWidth:o.width,viewportHeight:o.height}),r.jsxs("section",{ref:s=>{j.current=s},className:`overlay-card ${u?"overlay-card-dragging":""}`,style:{position:"absolute",left:`${a.x}px`,top:`${a.y}px`,cursor:u?"grabbing":"grab"},onMouseEnter:()=>E("interactive"),onMouseLeave:()=>!u&&E("passthrough"),onMouseDown:R,children:[r.jsx("p",{className:"overlay-label",children:y?"Next step":"Waiting for instructions"}),r.jsx("h1",{className:"overlay-title",children:y?.label??"No instruction yet"}),r.jsx("p",{className:"overlay-text",children:y?.step_description??"Trigger a task from the chat window to get started."}),S.length>0&&r.jsx("ol",{className:"overlay-step-list",children:S.map((s,w)=>r.jsxs("li",{className:w===0?"overlay-step-active":"",children:[r.jsx("strong",{children:s.label}),r.jsx("span",{children:s.step_description})]},s.id))}),r.jsx(Y,{onClick:B,disabled:!y,children:"Mark done"})]})]})},N=document.getElementById("root");if(!N)throw new Error("Overlay root element not found");const _=X.createRoot(N);_.render(r.jsx(U,{}));
