import{j as s,r as h,c as D}from"./index-D6HAasR3.js";const X=({variant:e="primary",className:t="",loading:n=!1,disabled:a,children:o,...r})=>{const d=["visor-button",e==="ghost"?"visor-button--ghost":"visor-button--primary",n?"visor-button--loading":"",t].filter(Boolean).join(" ");return s.jsx("button",{className:d,disabled:a||n,...r,children:n?s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"visor-button-spinner"}),s.jsx("span",{style:{opacity:.7},children:"Loading..."})]}):o})};function Y(e){const t=Math.max(e.width,e.height)*1.5,n=e.x+e.width/2-t/2,a=e.y+e.height/2-t/2;return{left:`${n}px`,top:`${a}px`,width:`${t}px`,height:`${t}px`,borderRadius:`${t}px`,border:"1.5px solid rgba(255, 255, 255, 0.92)",boxShadow:"0 0 0 1px rgba(255, 255, 255, 0.22) inset, 0 10px 26px rgba(0, 0, 0, 0.28)",background:"transparent"}}const C={width:1920,height:1080};function H(){return typeof window>"u"?C:{width:window.innerWidth,height:window.innerHeight}}function E(e,t){return Math.min(Math.max(e,0),t)}function N(e){return{x:e.x+e.width/2,y:e.y+e.height/2}}function I(e,t=e){const n=H(),a=N(t),o=N(e),r=Math.max(Math.abs(o.y-a.y),120),d={x:E((a.x+o.x)/2,n.width),y:E(Math.min(a.y,o.y)-r,n.height)},M=E(a.x,n.width),w=E(a.y,n.height),f=E(o.x,n.width),p=E(o.y,n.height);return`M ${M} ${w} Q ${d.x} ${d.y} ${f} ${p}`}function O(e,t){const n={left:`${t.x}px`,top:`${t.y}px`,width:`${t.width}px`,height:`${t.height}px`};return e==="circle"?{type:e,boxStyle:Y(t)}:e==="arrow"?{type:e,boxStyle:n,arrowPath:I(t)}:{type:"box",boxStyle:{...n,borderRadius:"14px",border:"1.5px solid rgba(255, 255, 255, 0.92)",boxShadow:"0 0 0 1px rgba(255, 255, 255, 0.22) inset, 0 10px 26px rgba(0, 0, 0, 0.28)",background:"transparent"}}}const _=({instruction:e,viewportWidth:t,viewportHeight:n})=>{const o=h.useMemo(()=>T(e,t,n),[e,t,n]);if(!e||!o)return null;const r=O(e.shape,o);return z(o,t,n),s.jsxs("div",{className:"annotation-layer",children:[s.jsx("div",{className:"bbox-hit-target",style:K(o),onClick:()=>{try{const d=e.id;window?.visor?.overlay?.markDone?.(d)}catch{}},title:""}),r.type==="box"&&s.jsx("div",{className:"annotation-box",style:r.boxStyle}),r.type==="circle"&&s.jsx("div",{className:"annotation-circle",style:r.boxStyle}),r.type==="arrow"&&r.arrowPath&&s.jsx("svg",{className:"annotation-arrow",viewBox:`0 0 ${t} ${n}`,preserveAspectRatio:"xMidYMid meet",children:s.jsx("path",{d:r.arrowPath})}),!1]})};function T(e,t,n){if(!e)return null;const a=t||(typeof window<"u"?window.innerWidth:1920),o=n||(typeof window<"u"?window.innerHeight:1080),r=e.viewport?.width??a,d=e.viewport?.height??o,M=r?a/r:1,w=d?o/d:1,f=e.bboxPixels?{x:e.bboxPixels.x,y:e.bboxPixels.y,width:e.bboxPixels.width,height:e.bboxPixels.height}:e.bbox?{x:e.bbox.x*r,y:e.bbox.y*d,width:e.bbox.width*r,height:e.bbox.height*d}:null;return f?V({x:f.x*M,y:f.y*w,width:f.width*M,height:f.height*w},a,o):null}function V(e,t,n){const a=Math.min(e.width,t),o=Math.min(e.height,n);return{x:Math.min(Math.max(e.x,0),Math.max(0,t-a)),y:Math.min(Math.max(e.y,0),Math.max(0,n-o)),width:Math.max(1,a),height:Math.max(1,o)}}function z(e,t,n){const o=Math.max(0,t-220),r=Math.min(Math.max(e.x,0),o),d=Math.min(e.y+e.height+12,Math.max(0,n-60));return{left:`${r}px`,top:`${d}px`}}function K(e){return{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,pointerEvents:"auto",background:"transparent"}}const U={width:typeof window<"u"?window.innerWidth:1920,height:typeof window<"u"?window.innerHeight:1080},F=()=>{const[e,t]=h.useState([]),[n,a]=h.useState(0),[o,r]=h.useState(!1),[d,M]=h.useState(U),[w,f]=h.useState(()=>{const i=typeof window<"u"?window.innerWidth:1920,c=320,l=32;return{x:Math.max(0,i-c-l),y:l}}),[p,k]=h.useState(!1),m=h.useRef(null),$=h.useRef(null),x=typeof window<"u"?window.visor?.overlay:void 0,y=e[n]??null,L=h.useMemo(()=>e.slice(n),[e,n]);h.useEffect(()=>{if(typeof window>"u")return;const i=()=>{M({width:window.innerWidth,height:window.innerHeight}),f(c=>{const l=$.current,g=l?l.offsetWidth:320,b=l?l.offsetHeight:200,u=Math.max(0,window.innerWidth-g-8),v=Math.max(0,window.innerHeight-b-8);return{x:Math.max(0,Math.min(c.x,u)),y:Math.max(0,Math.min(c.y,v))}})};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),h.useEffect(()=>{if(!x)return;x.ready?.();const i=x.onStepUpdate?.(l=>{r(!1),t(g=>{const b=g.findIndex(j=>j.id===l.id);let u,v;return b>=0?(u=[...g],u[b]=l,v=b):(u=[...g,l],v=u.length-1),a(v),u})}),c=x.onReset?.(()=>{t([]),a(0),r(!1)});return()=>{i?.(),c?.()}},[x]);const S=h.useCallback(()=>{y&&(r(!0),x?.markDone?.(y.id))},[y,x]);h.useEffect(()=>{const i=c=>{if(c.key==="Enter"&&!c.shiftKey){c.preventDefault(),S();return}if((c.metaKey||c.ctrlKey)&&c.key==="Enter"){c.preventDefault(),S();return}c.key==="Escape"&&(c.preventDefault(),S())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[S]);const P=h.useCallback(i=>{x?.setPointerMode?.(i)},[x]),W=h.useCallback(i=>{k(!0),m.current={mouseX:i.clientX,mouseY:i.clientY,x:w.x,y:w.y},x?.setPointerMode?.("interactive")},[w,x]);return h.useEffect(()=>{const i=l=>{if(!p||!m.current)return;const g=l.clientX-m.current.mouseX,b=l.clientY-m.current.mouseY,u=$.current,v=u?u.offsetWidth:320,j=u?u.offsetHeight:200,R=Math.max(0,(typeof window<"u"?window.innerWidth:d.width)-v-8),A=Math.max(0,(typeof window<"u"?window.innerHeight:d.height)-j-8);f({x:Math.max(0,Math.min(R,m.current.x+g)),y:Math.max(0,Math.min(A,m.current.y+b))})},c=()=>{k(!1),m.current=null,x?.setPointerMode?.("passthrough")};return p&&(window.addEventListener("mousemove",i),window.addEventListener("mouseup",c,{once:!0})),()=>{window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",c)}},[p,x,d.height,d.width]),s.jsxs("div",{className:"overlay-shell",children:[s.jsx(_,{instruction:y,viewportWidth:d.width,viewportHeight:d.height}),s.jsxs("section",{ref:i=>{$.current=i},className:`overlay-card ${p?"overlay-card-dragging":""}`,style:{position:"absolute",left:`${w.x}px`,top:`${w.y}px`,cursor:p?"grabbing":"grab"},onMouseEnter:()=>P("interactive"),onMouseLeave:()=>!p&&P("passthrough"),onMouseDown:W,children:[s.jsx("p",{className:"overlay-label",children:y?"Next step":"Waiting for instructions"}),s.jsx("h1",{className:"overlay-title",children:y?.label??"No instruction yet"}),s.jsx("p",{className:"overlay-text",children:y?.step_description??"Trigger a task from the chat window to get started."}),L.length>0&&s.jsx("ol",{className:"overlay-step-list",children:L.map((i,c)=>s.jsxs("li",{className:c===0?"overlay-step-active":"",children:[s.jsx("strong",{children:i.label}),s.jsx("span",{children:i.step_description})]},i.id))}),s.jsx(X,{onClick:S,disabled:!y,loading:o,children:"Mark done"})]})]})},B=document.getElementById("root");if(!B)throw new Error("Overlay root element not found");const Q=D.createRoot(B);Q.render(s.jsx(F,{}));
