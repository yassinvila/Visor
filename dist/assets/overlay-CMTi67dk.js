import{j as r,r as c,c as q}from"./index-D6HAasR3.js";const G=({variant:t="primary",className:e="",loading:n=!1,disabled:a,children:i,...d})=>{const o=["visor-button",t==="ghost"?"visor-button--ghost":"visor-button--primary",n?"visor-button--loading":"",e].filter(Boolean).join(" ");return r.jsx("button",{className:o,disabled:a||n,...d,children:n?r.jsxs(r.Fragment,{children:[r.jsx("span",{className:"visor-button-spinner"}),r.jsx("span",{style:{opacity:.7},children:"Loading..."})]}):i})};function J(t){const e=Math.max(t.width,t.height)*1.5,n=t.x+t.width/2-e/2,a=t.y+t.height/2-e/2;return{left:`${n}px`,top:`${a}px`,width:`${e}px`,height:`${e}px`,borderRadius:`${e}px`,border:"1.5px solid rgba(255, 255, 255, 0.92)",boxShadow:"0 0 0 1px rgba(255, 255, 255, 0.22) inset, 0 10px 26px rgba(0, 0, 0, 0.28)",background:"transparent"}}const K={width:1920,height:1080};function Z(){return typeof window>"u"?K:{width:window.innerWidth,height:window.innerHeight}}function E(t,e){return Math.min(Math.max(t,0),e)}function V(t){return{x:t.x+t.width/2,y:t.y+t.height/2}}function tt(t,e=t){const n=Z(),a=V(e),i=V(t),d=Math.max(Math.abs(i.y-a.y),120),o={x:E((a.x+i.x)/2,n.width),y:E(Math.min(a.y,i.y)-d,n.height)},j=E(a.x,n.width),f=E(a.y,n.height),u=E(i.x,n.width),y=E(i.y,n.height);return`M ${j} ${f} Q ${o.x} ${o.y} ${u} ${y}`}function et(t,e){const n={left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`};return t==="circle"?{type:t,boxStyle:J(e)}:t==="arrow"?{type:t,boxStyle:n,arrowPath:tt(e)}:{type:"box",boxStyle:{...n,borderRadius:"14px",border:"1.5px solid rgba(255, 255, 255, 0.92)",boxShadow:"0 0 0 1px rgba(255, 255, 255, 0.22) inset, 0 10px 26px rgba(0, 0, 0, 0.28)",background:"transparent"}}}const nt=({instruction:t,viewportWidth:e,viewportHeight:n})=>{const a=c.useMemo(()=>ot(t,e,n),[t,e,n]);if(!t||!a)return null;const i=et(t.shape,a),d=st(a,e,n);return r.jsxs("div",{className:"annotation-layer",children:[i.type==="box"&&r.jsx("div",{className:"annotation-box",style:i.boxStyle}),i.type==="circle"&&r.jsx("div",{className:"annotation-circle",style:i.boxStyle}),i.type==="arrow"&&i.arrowPath&&r.jsx("svg",{className:"annotation-arrow",viewBox:`0 0 ${e} ${n}`,preserveAspectRatio:"xMidYMid meet",children:r.jsx("path",{d:i.arrowPath})}),r.jsx("div",{className:"annotation-label",style:d,children:t.label})]})};function ot(t,e,n){if(!t)return null;const a=e||(typeof window<"u"?window.innerWidth:1920),i=n||(typeof window<"u"?window.innerHeight:1080),d=t.viewport?.width??a,o=t.viewport?.height??i,j=d?a/d:1,f=o?i/o:1,u=t.bboxPixels?{x:t.bboxPixels.x,y:t.bboxPixels.y,width:t.bboxPixels.width,height:t.bboxPixels.height}:t.bbox?{x:t.bbox.x*d,y:t.bbox.y*o,width:t.bbox.width*d,height:t.bbox.height*o}:null;return u?it({x:u.x*j,y:u.y*f,width:u.width*j,height:u.height*f},a,i):null}function it(t,e,n){const a=Math.min(t.width,e),i=Math.min(t.height,n);return{x:Math.min(Math.max(t.x,0),Math.max(0,e-a)),y:Math.min(Math.max(t.y,0),Math.max(0,n-i)),width:Math.max(1,a),height:Math.max(1,i)}}function st(t,e,n){const i=Math.max(0,e-220),d=Math.min(Math.max(t.x,0),i),o=Math.min(t.y+t.height+12,Math.max(0,n-60));return{left:`${d}px`,top:`${o}px`}}const at={width:typeof window<"u"?window.innerWidth:1920,height:typeof window<"u"?window.innerHeight:1080},rt=()=>{const[t,e]=c.useState([]),[n,a]=c.useState(0),[i,d]=c.useState(!1),[o,j]=c.useState(at),[f,u]=c.useState(()=>{const h=typeof window<"u"?window.innerWidth:1920,w=320,s=32;return{x:Math.max(0,h-w-s),y:s}}),[y,C]=c.useState(!1),g=c.useRef(null),W=c.useRef(null),x=typeof window<"u"?window.visor?.overlay:void 0,m=t[n]??null,H=c.useMemo(()=>t.slice(n),[t,n]);c.useEffect(()=>{if(typeof window>"u")return;const h=()=>{j({width:window.innerWidth,height:window.innerHeight}),u(w=>{const s=W.current,p=s?s.offsetWidth:320,M=s?s.offsetHeight:200,l=Math.max(0,window.innerWidth-p-8),v=Math.max(0,window.innerHeight-M-8);return{x:Math.max(0,Math.min(w.x,l)),y:Math.max(0,Math.min(w.y,v))}})};return window.addEventListener("resize",h),()=>window.removeEventListener("resize",h)},[]),c.useEffect(()=>{if(!x)return;x.ready?.();const h=x.onStepUpdate?.(s=>{d(!1),e(p=>{const M=p.findIndex(b=>b.id===s.id);let l,v;M>=0?(l=[...p],l[M]=s,v=M):(l=[...p,s],v=l.length-1),a(v);try{const b=s.viewport?.width??o.width,P=s.viewport?.height??o.height,B=b?o.width/b:1,I=P?o.height/P:1,N=s.bboxPixels?{x:s.bboxPixels.x,y:s.bboxPixels.y,width:s.bboxPixels.width,height:s.bboxPixels.height}:s.bbox?{x:s.bbox.x*b,y:s.bbox.y*P,width:s.bbox.width*b,height:s.bbox.height*P}:null;if(N){const L={x:Math.max(0,Math.min(N.x*B,o.width)),y:Math.max(0,Math.min(N.y*I,o.height)),width:Math.max(1,N.width*B),height:Math.max(1,N.height*I)},D=12,U=320,_=200,X=W.current,Y=X?X.offsetWidth:U,R=X?X.offsetHeight:_;let k=L.x+L.width+D,S=L.y;k+Y+8>o.width&&(k=Math.max(8,L.x-Y-D)),S+R+8>o.height&&(S=Math.max(8,o.height-R-8));const $=24,F=Math.max($,Math.min(Math.round(k),Math.max($,o.width-Y-$))),Q=Math.max($,Math.min(Math.round(S),Math.max($,o.height-R-$)));u({x:F,y:Q})}}catch{}return l})}),w=x.onReset?.(()=>{e([]),a(0),d(!1)});return()=>{h?.(),w?.()}},[x]);const O=c.useCallback(()=>{m&&(d(!0),x?.markDone?.(m.id))},[m,x]),A=c.useCallback(h=>{x?.setPointerMode?.(h)},[x]),T=c.useCallback(h=>{C(!0),g.current={mouseX:h.clientX,mouseY:h.clientY,x:f.x,y:f.y},x?.setPointerMode?.("interactive")},[f,x]);return c.useEffect(()=>{const h=s=>{if(!y||!g.current)return;const p=s.clientX-g.current.mouseX,M=s.clientY-g.current.mouseY,l=W.current,v=l?l.offsetWidth:320,b=l?l.offsetHeight:200,P=Math.max(0,(typeof window<"u"?window.innerWidth:o.width)-v-8),B=Math.max(0,(typeof window<"u"?window.innerHeight:o.height)-b-8);u({x:Math.max(0,Math.min(P,g.current.x+p)),y:Math.max(0,Math.min(B,g.current.y+M))})},w=()=>{C(!1),g.current=null,x?.setPointerMode?.("passthrough")};return y&&(window.addEventListener("mousemove",h),window.addEventListener("mouseup",w,{once:!0})),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",w)}},[y,x,o.height,o.width]),r.jsxs("div",{className:"overlay-shell",children:[r.jsx(nt,{instruction:m,viewportWidth:o.width,viewportHeight:o.height}),r.jsxs("section",{ref:h=>{W.current=h},className:`overlay-card ${y?"overlay-card-dragging":""}`,style:{position:"absolute",left:`${f.x}px`,top:`${f.y}px`,cursor:y?"grabbing":"grab"},onMouseEnter:()=>A("interactive"),onMouseLeave:()=>!y&&A("passthrough"),onMouseDown:T,children:[r.jsx("p",{className:"overlay-label",children:m?"Next step":"Waiting for instructions"}),r.jsx("h1",{className:"overlay-title",children:m?.label??"No instruction yet"}),r.jsx("p",{className:"overlay-text",children:m?.step_description??"Trigger a task from the chat window to get started."}),H.length>0&&r.jsx("ol",{className:"overlay-step-list",children:H.map((h,w)=>r.jsxs("li",{className:w===0?"overlay-step-active":"",children:[r.jsx("strong",{children:h.label}),r.jsx("span",{children:h.step_description})]},h.id))}),r.jsx(G,{onClick:O,disabled:!m,loading:i,children:"Mark done"})]})]})},z=document.getElementById("root");if(!z)throw new Error("Overlay root element not found");const ht=q.createRoot(z);ht.render(r.jsx(rt,{}));
